<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devlog Viewer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0d1117; color: #e6edf3; padding: 20px; max-width: 1200px; margin: 0 auto; }
    h1 { color: #58a6ff; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    h1::before { content: ""; display: inline-block; width: 32px; height: 32px; background: linear-gradient(135deg, #58a6ff 0%, #bc8cff 100%); border-radius: 8px; }
    .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    select, input { padding: 10px 14px; border-radius: 8px; border: 1px solid #30363d; background: #161b22; color: #e6edf3; font-size: 14px; min-width: 150px; }
    select:focus, input:focus { outline: none; border-color: #58a6ff; }
    input[type="text"] { flex: 1; min-width: 200px; }
    .devlog { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 18px; margin-bottom: 14px; transition: border-color 0.2s; cursor: pointer; }
    .devlog:hover { border-color: #58a6ff; }
    .devlog.expanded { border-color: #58a6ff; background: #1c2128; }
    .devlog-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 12px; flex-wrap: wrap; }
    .devlog-title { color: #58a6ff; font-weight: 600; font-size: 16px; }
    .devlog-meta { color: #8b949e; font-size: 13px; display: flex; gap: 8px; flex-wrap: wrap; }
    .devlog-meta span { background: #21262d; padding: 2px 8px; border-radius: 4px; }
    .devlog-content { color: #c9d1d9; line-height: 1.6; font-size: 14px; }
    .devlog-content pre { background: #0d1117; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 10px 0; }
    .devlog-content code { font-family: "JetBrains Mono", "Fira Code", monospace; font-size: 13px; }
    .devlog-content h2, .devlog-content h3, .devlog-content h4 { color: #e6edf3; margin: 12px 0 8px 0; }
    .devlog-content h2 { font-size: 18px; }
    .devlog-content h3 { font-size: 16px; }
    .devlog-content h4 { font-size: 14px; }
    .devlog-content a { color: #58a6ff; text-decoration: none; }
    .devlog-content a:hover { text-decoration: underline; }
    .devlog-content ul { margin: 8px 0; padding-left: 20px; list-style: disc; }
    .devlog-content li { margin: 4px 0; }
    .devlog-content em { font-style: italic; }
    .devlog-content strong { font-weight: 600; }
    .tags { margin-top: 12px; display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { background: #238636; color: #fff; padding: 3px 10px; border-radius: 12px; font-size: 12px; }
    .type-feature { border-left: 4px solid #3fb950; }
    .type-bugfix { border-left: 4px solid #f85149; }
    .type-deployment { border-left: 4px solid #58a6ff; }
    .type-refactor { border-left: 4px solid #bc8cff; }
    .type-config { border-left: 4px solid #d29922; }
    .type-incident { border-left: 4px solid #f85149; }
    .type-research { border-left: 4px solid #39c5cf; }
    .type-note { border-left: 4px solid #8b949e; }
    .loading { text-align: center; padding: 60px; color: #8b949e; font-size: 16px; }
    .error-banner { background: #f8514926; border: 1px solid #f85149; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; color: #f85149; display: none; }
    .error-banner.visible { display: block; }
    .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 14px 20px; }
    .stat-value { font-size: 24px; font-weight: 600; color: #58a6ff; }
    .stat-label { font-size: 12px; color: #8b949e; margin-top: 4px; }
    @media (max-width: 600px) {
      .devlog-header { flex-direction: column; }
      .filters { flex-direction: column; }
      select, input { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>Devlog Viewer</h1>

  <div class="error-banner" id="error-banner"></div>

  <div class="stats" id="stats">
    <div class="stat"><div class="stat-value" id="total-count">-</div><div class="stat-label">Total Devlogs</div></div>
    <div class="stat"><div class="stat-value" id="service-count">-</div><div class="stat-label">Services</div></div>
  </div>

  <div class="filters">
    <select id="service-filter"><option value="">All Services</option></select>
    <select id="type-filter">
      <option value="">All Types</option>
      <option value="feature">Feature</option>
      <option value="bugfix">Bugfix</option>
      <option value="deployment">Deployment</option>
      <option value="refactor">Refactor</option>
      <option value="config">Config</option>
      <option value="incident">Incident</option>
      <option value="research">Research</option>
      <option value="note">Note</option>
    </select>
    <input type="text" id="search" placeholder="Search devlogs...">
  </div>

  <div id="devlogs"><div class="loading">Loading devlogs...</div></div>

  <script>
    const API = "/api";
    let allDevlogs = [];
    let services = [];
    let expandedIds = new Set();

    function showError(msg) {
      const banner = document.getElementById("error-banner");
      banner.textContent = msg;
      banner.classList.add("visible");
    }

    function hideError() {
      document.getElementById("error-banner").classList.remove("visible");
    }

    async function loadServices() {
      try {
        const resp = await fetch(API + "/services");
        const data = await resp.json();
        if (data.error) {
          showError("Backend unavailable - showing cached data if available");
        } else {
          hideError();
        }
        services = data.services || data || [];
        document.getElementById("service-count").textContent = services.length;

        const select = document.getElementById("service-filter");
        services.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id || s.service_id;
          opt.textContent = s.name || s.id || s.service_id;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error("Failed to load services:", e);
        showError("Cannot connect to server");
      }
    }

    async function loadDevlogs() {
      try {
        const service = document.getElementById("service-filter").value;
        const type = document.getElementById("type-filter").value;
        const params = new URLSearchParams();
        if (service) params.set("service_id", service);
        if (type) params.set("log_type", type);
        params.set("limit", "100");

        const resp = await fetch(API + "/devlogs?" + params);
        const data = await resp.json();
        if (data.error && !data.devlogs?.length) {
          showError("Backend unavailable - " + data.error);
        }
        allDevlogs = data.devlogs || data || [];
        document.getElementById("total-count").textContent = allDevlogs.length;
        renderDevlogs();
      } catch (e) {
        console.error("Failed to load devlogs:", e);
        showError("Cannot connect to server");
        document.getElementById("devlogs").innerHTML = '<div class="loading">Unable to load devlogs</div>';
      }
    }

    function formatContent(content) {
      if (!content) return "";
      // Markdown formatting
      return content
        // Code blocks first (before other processing)
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Headers (must be at line start)
        .replace(/^### (.+)$/gm, '<h4>$1</h4>')
        .replace(/^## (.+)$/gm, '<h3>$1</h3>')
        .replace(/^# (.+)$/gm, '<h2>$1</h2>')
        // Bold and italic
        .replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/_([^_]+)_/g, '<em>$1</em>')
        // Links
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
        // Unordered lists
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        // Line breaks
        .replace(/\n/g, '<br>')
        // Wrap consecutive list items
        .replace(/(<li>.*<\/li>(<br>)?)+/g, '<ul>$&</ul>')
        .replace(/<br><\/ul>/g, '</ul>')
        .replace(/<ul><br>/g, '<ul>');
    }

    function toggleExpand(id, event) {
      event.stopPropagation();
      if (expandedIds.has(id)) {
        expandedIds.delete(id);
      } else {
        expandedIds.add(id);
      }
      renderDevlogs();
    }

    function renderDevlogs() {
      const search = document.getElementById("search").value.toLowerCase();
      const filtered = allDevlogs.filter(d =>
        !search ||
        d.title.toLowerCase().includes(search) ||
        (d.content || "").toLowerCase().includes(search) ||
        (d.tags || []).some(t => t.toLowerCase().includes(search))
      );

      const container = document.getElementById("devlogs");
      if (filtered.length === 0) {
        container.innerHTML = '<div class="loading">No devlogs found</div>';
        return;
      }

      container.innerHTML = filtered.map(d => {
        const date = new Date(d.created_at).toLocaleString();
        const tags = (d.tags || []).map(t => `<span class="tag">${t}</span>`).join("");
        const isExpanded = expandedIds.has(d.id);
        const rawContent = d.content || "";
        const needsTruncation = rawContent.length > 300;
        const displayContent = isExpanded || !needsTruncation
          ? formatContent(rawContent)
          : formatContent(rawContent.substring(0, 300));
        const expandClass = isExpanded ? "expanded" : "";
        const hint = !isExpanded && needsTruncation ? '<div style="color:#8b949e;font-size:12px;margin-top:8px">Click to expand...</div>' : '';

        return `
          <div class="devlog type-${d.log_type} ${expandClass}" onclick="toggleExpand('${d.id}', event)" data-id="${d.id}">
            <div class="devlog-header">
              <span class="devlog-title">${d.title}</span>
              <div class="devlog-meta">
                <span>${d.service_id}</span>
                <span>${d.log_type}</span>
                <span>${date}</span>
                ${d.author ? `<span>${d.author}</span>` : ""}
              </div>
            </div>
            <div class="devlog-content">${displayContent}${!isExpanded && needsTruncation ? "..." : ""}</div>
            ${hint}
            ${tags ? `<div class="tags">${tags}</div>` : ""}
          </div>
        `;
      }).join("");
    }

    document.getElementById("service-filter").addEventListener("change", loadDevlogs);
    document.getElementById("type-filter").addEventListener("change", loadDevlogs);
    document.getElementById("search").addEventListener("input", renderDevlogs);

    // Initialize
    loadServices();
    loadDevlogs();
  </script>
</body>
</html>
